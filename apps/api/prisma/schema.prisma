generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


//////////////////////
// ENUMS
//////////////////////

enum UserRole {
  super_admin
  admin
  moderator
  advertiser
  publisher
}

enum UserStatus {
  active
  suspended
  banned
}

enum ChannelStatus {
  pending
  verified
  approved
  rejected
  blocked
}

enum CampaignStatus {
  draft
  active
  paused
  completed
  cancelled
}

enum CampaignTargetStatus {
  pending
  submitted
  approved
  rejected
  posted
  failed
  refunded
}

enum CreativeType {
  text
  image
  video
}

enum PostJobStatus {
  queued
  sending
  success
  failed
}

enum LedgerType {
  debit
  credit
}

enum LedgerReason {
  deposit
  escrow_hold
  payout
  commission
  refund
}

enum EscrowStatus {
  held
  released
  refunded
}

enum KillSwitchKey {
  payouts
  new_escrows
  telegram_posting
  worker_post
  worker_reconciliation
  worker_watchdogs
}

//////////////////////
// USERS & AUDIT
//////////////////////

model User {
  id         String     @id @default(uuid())
  telegramId BigInt     @unique
  username   String?
  passwordHash String?
  role       UserRole
  status     UserStatus @default(active)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  auditLogs UserAuditLog[]
  channels  Channel[]
  wallet    Wallet?
  campaigns Campaign[]

  // ✅ QO‘SHILADI
  verifiedChannels  ChannelVerification[]
  approvedCreatives AdCreative[]

  @@index([telegramId])
  @@index([status])
  @@map("users")
}

model UserAuditLog {
  id        String   @id @default(uuid())
  userId    String
  action    String
  metadata  Json?
  ipAddress String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("user_audit_logs")
}

//////////////////////
// CHANNELS
//////////////////////

model Channel {
  id                String  @id @default(uuid())
  telegramChannelId BigInt  @unique
  title             String
  username          String?
  category          String?
  subscriberCount   Int     @default(0)
  avgViews          Int     @default(0)
  cpm               Decimal @default(0) @db.Decimal(10, 2)

  status    ChannelStatus @default(pending)
  createdAt DateTime      @default(now())
  deletedAt DateTime?

  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id])

  stats        ChannelStatDaily[]
  verification ChannelVerification?

  // ✅ QO‘SHILADI
  campaignTargets CampaignTarget[]

  @@index([ownerId])
  @@index([status])
  @@map("channels")
}

model ChannelStatDaily {
  id             String   @id @default(uuid())
  channelId      String
  date           DateTime @db.Date
  subscribers    Int?
  views          Int?
  engagementRate Decimal? @db.Decimal(5, 2)

  channel Channel @relation(fields: [channelId], references: [id])

  @@unique([channelId, date])
  @@map("channel_stats_daily")
}

model ChannelVerification {
  id         String   @id @default(uuid())
  channelId  String   @unique
  verifiedBy String?
  fraudScore Int
  notes      String?
  createdAt  DateTime @default(now())

  channel Channel @relation(fields: [channelId], references: [id])
  admin   User?   @relation(fields: [verifiedBy], references: [id])

  @@map("channel_verification")
}

//////////////////////
// CAMPAIGNS
//////////////////////

model Campaign {
  id           String @id @default(uuid())
  advertiserId String
  name         String

  totalBudget Decimal @db.Decimal(14, 2)
  spentBudget Decimal @default(0) @db.Decimal(14, 2)

  status  CampaignStatus @default(draft)
  startAt DateTime?
  endAt   DateTime?

  createdAt DateTime @default(now())

  advertiser User             @relation(fields: [advertiserId], references: [id])
  targets    CampaignTarget[]
  creatives  AdCreative[]
  financialAuditEvents FinancialAuditEvent[]

  @@index([advertiserId])
  @@index([status])
  @@map("campaigns")
}

model CampaignTarget {
  id         String @id @default(uuid())
  campaignId String
  channelId  String

  price       Decimal              @db.Decimal(12, 2)
  scheduledAt DateTime
  status      CampaignTargetStatus @default(pending)
  moderatedBy String?
  moderatedAt DateTime?
  moderationReason String?

  campaign Campaign @relation(fields: [campaignId], references: [id])
  channel  Channel  @relation(fields: [channelId], references: [id])
  moderator User? @relation(fields: [moderatedBy], references: [id])

  postJob    PostJob?
  escrow     Escrow?
  commission PlatformCommission?
  financialAuditEvents FinancialAuditEvent[]

  @@index([campaignId])
  @@index([scheduledAt])
  @@map("campaign_targets")
}

model AdCreative {
  id         String @id @default(uuid())
  campaignId String

  contentType    CreativeType
  contentPayload Json

  approvedBy String?
  approvedAt DateTime?

  campaign Campaign @relation(fields: [campaignId], references: [id])
  admin    User?    @relation(fields: [approvedBy], references: [id])

  @@map("ad_creatives")
}

//////////////////////
// POSTING ENGINE
//////////////////////

model PostJob {
  id               String @id @default(uuid())
  campaignTargetId String @unique

  executeAt DateTime
  attempts  Int           @default(0)
  status    PostJobStatus @default(queued)
  lastError String?

  campaignTarget CampaignTarget     @relation(fields: [campaignTargetId], references: [id])
  executions     PostExecutionLog[]

  @@index([executeAt, status])
  @@map("post_jobs")
}

model PostExecutionLog {
  id                String   @id @default(uuid())
  postJobId         String
  telegramMessageId BigInt?
  executedAt        DateTime @default(now())
  responsePayload   Json?

  postJob PostJob @relation(fields: [postJobId], references: [id])

  @@map("post_execution_logs")
}

//////////////////////
// WALLET & LEDGER
//////////////////////

model Wallet {
  id     String @id @default(uuid())
  userId String @unique

  balance  Decimal @default(0) @db.Decimal(14, 2)
  currency String  @default("USD")

  createdAt DateTime @default(now())

  user   User          @relation(fields: [userId], references: [id])
  ledger LedgerEntry[]
  financialAuditEvents FinancialAuditEvent[]

  advertiserEscrows Escrow[] @relation("AdvertiserWallet")
  publisherEscrows  Escrow[] @relation("PublisherWallet")

  @@map("wallets")
}

model LedgerEntry {
  id       String @id @default(uuid())
  walletId String

  type   LedgerType
  amount Decimal      @db.Decimal(14, 2)
  reason LedgerReason
  idempotencyKey String? @unique

  referenceId String?
  createdAt   DateTime @default(now())

  wallet Wallet @relation(fields: [walletId], references: [id])
  auditEvents FinancialAuditEvent[]

  @@index([walletId])
  @@map("ledger_entries")
}

//////////////////////
// ESCROW & COMMISSION
//////////////////////

model Escrow {
  id String @id @default(uuid())

  campaignTargetId   String @unique
  advertiserWalletId String
  publisherWalletId  String

  amount Decimal      @db.Decimal(12, 2)
  status EscrowStatus @default(held)

  createdAt  DateTime  @default(now())
  releasedAt DateTime?
  refundedAt DateTime?

  campaignTarget   CampaignTarget @relation(fields: [campaignTargetId], references: [id])
  advertiserWallet Wallet         @relation(name: "AdvertiserWallet", fields: [advertiserWalletId], references: [id])
  publisherWallet  Wallet         @relation(name: "PublisherWallet", fields: [publisherWalletId], references: [id])
  financialAuditEvents FinancialAuditEvent[]

  @@map("escrows")
}

model PlatformCommission {
  id String @id @default(uuid())

  campaignTargetId String  @unique
  amount           Decimal @db.Decimal(12, 2)
  percentage       Decimal @db.Decimal(5, 2)

  createdAt DateTime @default(now())

  campaignTarget CampaignTarget @relation(fields: [campaignTargetId], references: [id])

  @@map("platform_commissions")
}

model FinancialAuditEvent {
  id               String   @id @default(uuid())
  walletId         String
  ledgerEntryId    String?
  campaignId       String?
  campaignTargetId String?
  escrowId         String?
  type             LedgerType
  amount           Decimal  @db.Decimal(14, 2)
  reason           LedgerReason
  actor            String?
  correlationId    String?
  createdAt        DateTime @default(now())

  wallet      Wallet      @relation(fields: [walletId], references: [id])
  ledgerEntry LedgerEntry? @relation(fields: [ledgerEntryId], references: [id])
  campaign    Campaign?   @relation(fields: [campaignId], references: [id])
  campaignTarget CampaignTarget? @relation(fields: [campaignTargetId], references: [id])
  escrow      Escrow?     @relation(fields: [escrowId], references: [id])

  @@index([walletId, createdAt])
  @@index([campaignId, createdAt])
  @@index([campaignTargetId, createdAt])
  @@map("financial_audit_events")
}

enum SystemActionType {
  FORCE_RELEASE
  FORCE_REFUND
  MANUAL_RESOLVE
}

model SystemActionLog {
  id        String @id @default(uuid())
  action    SystemActionType
  escrowId  String
  adminId   String
  reason    String
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([escrowId])
}

model KillSwitch {
  key       KillSwitchKey @id
  enabled   Boolean       @default(false)
  reason    String?
  updatedBy String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  events KillSwitchEvent[]

  @@map("kill_switches")
}

model KillSwitchEvent {
  id        String        @id @default(uuid())
  key       KillSwitchKey
  enabled   Boolean
  reason    String?
  updatedBy String
  metadata  Json?
  createdAt DateTime      @default(now())

  killSwitch KillSwitch @relation(fields: [key], references: [key])

  @@index([key, createdAt])
  @@map("kill_switch_events")
}
